<!DOCTYPE html>
<!--
 CAPTAIN SLOG
 vim: set expandtab tabstop=4 shiftwidth=4 autoindent smartindent:
 File         : text-track-3.html 
 System       : Advanced HTML5 Experiments
 Date         : December 2015 
 Author       : Mark Addinall
 Synopsis     : As the caption, submenu, track elements of VIDEO
                are all over the place depending on wich browser
                you are using, here we will use Javascript in the
                HTML5 element to manipulate the various track elements.

                I have stuck all the code in-line in here.  AWFUL
                practice, however, they are experiments and it
                makes it easier for others to pinch rather than following
                endless links around the bloody web!

                This takes the video control one step further by accessing
                the text track that is associated with any HTML5 multimedia
                object.  In this code we force the load of multi-media files
                via user actions (buttons).

                We add more and more control to the UI suggesting that an audio-visual tool
                can be built from this experiment.

                This time, we will just go a little bit further than in the 
                previous examples.
                When we click on a button, we will force the loading of the track, 
                we will read the content, add cue listeners in order to trigger 
                events when the video is played and we will display
                them on the side this time, and there are hyperlinks you can click 
                and if I click somewhere, the video starts at the corresponding location 
                and you can see that the cues are highlighted in black
-->
<html>
    <head>
        <title>Advanced HTML 5 Tracks Three</title>

        <style type="text/css">

        video::cue(.blue)   { color: blue }
        video::cue(.green)  { color: green }
        video::cue(.lime)   { color: lime }
        video::cue(.yellow) { color: yellow }

        #all {
            background-color: lightgrey;
            border-radius: 10px;
            paddinag: 20px;
            border: 1px solid;
            display: inline-block;
            margin: 30px;
            width: 90%
        }

        .cues {
            color: blue;
        }

        .cues:hover {
            text-decoration: underline;
        }

        .cues.current {
            color: black;
            font-weight: bold;
        }

        #first_video {
            display: block;
            float: left;
            margin-right: 3%;
            width: 66%;
            background-color: black;
            position: relative;
        }

        #transcript {
            padding: 10px;
            border: 1px solid;
            float: left;
            max-height: 225px;
            overflow: auto;
            width: 25%;
            margin: 0;
            font-size: 14px;
            list-style: none;
        }



        </style>


<script type="text/javascript">


//divs
var video, transcript_div;

// TextTracks, html tracks, urls of tracks
var tracks, track_elements, track_urls = []; 

// buttons
var english, kiwi;
 
window.onload = function() {

   console.log("init");
   
   
   video = document.querySelector("#first_video");              // when the page is loaded, get the different DOM nodes
   transcript_div = document.querySelector("#transcript");      // we're going to work with

   
   track_elements = document.querySelectorAll("track");         // The tracks as HTML elements
   
   for(var i = 0; i < track_elements.length; i++) {             // Get the URLs of the vtt files
      var current_track = track_elements[i];
      track_urls[i] = current_track.src;
   }

   english  = document.querySelector("#english");               // our buttons
   kiwi     = document.querySelector("#kiwi");
   
   
   english.disabled = false;                                    // we enable the buttons only in this load callback,
   kiwi.disabled = false;                                       // we cannot click before the video is in the DOM
   
   tracks = video.textTracks;                                   // The tracks as TextTrack JS objects
};



//----------------------------- 
function load_transcript(lang) {
  // Called when a button is clicked
  // clear current transcript
  clear_transcriptDiv();
  // set all track modes to disabled. We will only activate the
  // one whose content will be displayed as transcript
  disableAllTracks();
  // Locate the track with language = lang
  for(var i = 0; i < tracks.length; i++) {
    // current track
    var track = tracks[i];
    var trackAsHtmlElem = track_elements[i];
    // Only subtitles/captions are ok for this example...
    if((track.language === lang) && (track.kind !== "chapters")) {
       track.mode="showing";
 
       if(trackAsHtmlElem.readyState === 2) {
          // the track has already been loaded
          displayCues(track);
       } else {
          displayCuesAfterTrackLoaded(trackAsHtmlElem, track);
       }
    }
  }
}




function displayCuesAfterTrackLoaded(trackElem, track) {
  // Create a listener that will only be called once the track has
  // been loaded. We cannot display the transcript before
  // the track is loaded
   trackElem.addEventListener('load', function(e) {
      console.log("track loaded");
      displayCues(track);
   });
}
function disableAllTracks() {
  for(var i = 0; i < tracks.length; i++)
     // the track mode is important: disabled tracks do not fire events
     tracks[i].mode = "disabled"; 
}
 
function displayCues(track) { 
   // displays the transcript of a TextTrack
   var cues = track.cues;
   // iterate on all cues of the current track
   for(var i=0, len = cues.length; i < len; i++) {
      // current cue, also add enter and exit listeners to it
      var cue = cues[i];
      addCueListeners(cue);
 
      // Test if the cue content is a voice <v speaker>....</v>
      var voices = getVoices(cue.text);
      var transText="";
      if (voices.length > 0) {
         for (var j = 0; j < voices.length; j++) { // how many voices?
            transText += voices[j].voice + ': ' + removeHTML(voices[j].text);
         }
      } else
         transText = cue.text; // not a voice text
      var clickableTransText = "<li class='cues' id=" + cue.id
                               + " onclick='jumpTo("
                               + cue.startTime + ");'" + ">"
                               + transText + "</li>";
 
      addToTranscriptDiv(clickableTransText);
   }
}
 
function getVoices(speech) { 
   // takes a text content and check if there are voices
   var voices = []; // inside
   var pos = speech.indexOf('<v'); // voices are like <v Michel> ....
   while (pos != -1) {
      endVoice = speech.indexOf('>');
      var voice = speech.substring(pos + 2, endVoice).trim();
      var endSpeech = speech.indexOf('</v>');
      var text = speech.substring(endVoice + 1, endSpeech);
      voices.push({
          'voice': voice,
          'text': text
      });
      speech = speech.substring(endSpeech + 4);
      pos = speech.indexOf('<v');
  }
  return voices;
}
 
function removeHTML(text) {
  var div = document.createElement('div');
  div.innerHTML = text;
  return div.textContent || div.innerText || '';
}
function jumpTo(time) {
  // Make the video jump at the time position + force play
  // if it was not playing
  video.currentTime = time;
  video.play();
}
 
function clear_transcriptDiv() {
  transcript_div.innerHTML = "";
}
 
function addToTranscriptDiv(htmlText) {
  transcript_div.innerHTML += htmlText;
}
 
function addCueListeners(cue) {
  cue.onenter = function(){
     // Highlight current cue transcript by adding the
     // cue.current CSS class
     console.log('enter id=' + this.id);
     var transcriptText = document.getElementById(this.id);
     transcriptText.classList.add("current");
 };
 
cue.onexit = function(){
   console.log('exit id=' + cue.id);
   var transcriptText = document.getElementById(this.id);
   transcriptText.classList.remove("current");
 };
} // end of addCueListeners...




</script>

    </head>

    <body>
        <div id=container>
        <!-- container is my general purpose CSS wrapper that usually defines the overall
             look and feel of the HTML document.  This is the basic boilerplate item.  -->
        <section id="all">
            <button disabled id="english"
                onclick="load_transcript('en');">
                Display in English
            </button>
            <button disabled id="kiwi"
                onclick="load_transcript('mi');">
                Display in Kiwi
            </button>
            <video id="first_video" preload="metadata" controls crossOrigin="anonymous">
                <source src="sample.mp4" type="video/mp4">
                <source src="sample.mkv" type="video/mkv">
                Get a decent Browser
                <track label="Kiwi subtitles" kind="subtitles" srclang="mi"
                    src="sample-subtitles-kiwi.vtt" default>
                <track label="English subtitles" kind="subtitles" srclang="en"
                    src="sample-subtitles.vtt">
                <track label="English chapters" kind="chapters" srclang="en"
                    src="sample-chapters.vtt">
            </video>
            <div id="transcript"></div>
        </section>
        </div>
    </body>
</html>

